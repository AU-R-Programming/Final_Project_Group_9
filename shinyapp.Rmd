```{r}
library(shiny)

# Define UI
ui <- fluidPage(
  titlePanel("Supervised Binary Classification Using Numerical Optimization"),
  
  sidebarLayout(
    sidebarPanel(
      fileInput("datafile", "Upload CSV File", accept = c(".csv")),
      selectInput("response", "Select Response Variable:", choices = NULL),
      selectizeInput("predictors", "Select Predictor Variables:", choices = NULL, multiple = TRUE),
      numericInput("bootstrap", "Number of Bootstrap Iterations (B):", value = 1000, min = 100),
      numericInput("alpha", "Significance Level (Alpha):", value = 0.05, min = 0.01, max = 0.1, step = 0.01),
      actionButton("run", "Run Binary Classification"),
      downloadButton("downloadResults", "Download Results")
    ),
    
    mainPanel(
      h3("Results"),
      tabsetPanel(
        tabPanel("Coefficients", tableOutput("coefficients")),
        tabPanel("Confidence Intervals", tableOutput("confidence_intervals")),
        tabPanel("Confusion Matrix", tableOutput("confusion_matrix")),
        tabPanel("Performance Metrics", tableOutput("performance_metrics"))
      )
    )
  )
)

# Define server logic
server <- function(input, output, session) {
  
  # Load and validate dataset
  dataset <- reactive({
    req(input$datafile)
    tryCatch(
      {
        data <- read.csv(input$datafile$datapath)
        validate(need(ncol(data) > 1, "The uploaded file must contain at least two columns."))
        data
      },
      error = function(e) {
        showNotification("Error reading file. Please upload a valid CSV file.", type = "error")
        NULL
      }
    )
  })
  
  # Update UI choices for response and predictors
  observe({
    data <- dataset()
    if (!is.null(data)) {
      updateSelectInput(session, "response", choices = colnames(data))
      updateSelectizeInput(session, "predictors", choices = colnames(data))
    }
  })
  
  # Perform logistic regression
  logistic_regression <- function(X, y, B, alpha) {
    design <- cbind(1, X)
    
    # Define the negative log-likelihood function
    neg_log_likelihood <- function(beta) {
      p <- 1 / (1 + exp(-design %*% beta))
      -sum(y * log(p) + (1 - y) * log(1 - p))
    }
    
    # Optimize coefficients
    beta_init <- rep(0, ncol(design))
    result <- optim(beta_init, neg_log_likelihood, method = "BFGS")
    
    # Bootstrap confidence intervals
    B_hat <- replicate(B, {
      idx <- sample(seq_len(nrow(design)), replace = TRUE)
      X_boot <- design[idx, ]
      y_boot <- y[idx]
      boot_result <- optim(beta_init, function(beta) neg_log_likelihood(beta, X_boot, y_boot), method = "BFGS")
      boot_result$par
    })
    
    CI <- apply(B_hat, 1, function(b) quantile(b, c(alpha / 2, 1 - alpha / 2)))
    
    # Predict probabilities and evaluate performance
    p_hat <- 1 / (1 + exp(-design %*% result$par))
    y_pred <- ifelse(p_hat >= 0.5, 1, 0)
    
    true_positive <- sum(y == 1 & y_pred == 1)
    true_negative <- sum(y == 0 & y_pred == 0)
    false_positive <- sum(y == 0 & y_pred == 1)
    false_negative <- sum(y == 1 & y_pred == 0)
    
    confusion_matrix <- matrix(c(true_positive, false_negative, false_positive, true_negative), 
                               nrow = 2, 
                               dimnames = list(
                                 Actual = c("Positive", "Negative"),
                                 Predicted = c("Positive", "Negative")
                               ))
    
    accuracy <- (true_positive + true_negative) / length(y)
    sensitivity <- true_positive / (true_positive + false_negative)
    specificity <- true_negative / (true_negative + false_positive)
    
    list(
      beta = result$par,
      CI = CI,
      confusion_matrix = confusion_matrix,
      metrics = data.frame(
        Accuracy = accuracy,
        Sensitivity = sensitivity,
        Specificity = specificity
      )
    )
  }
  
  # Run logistic regression and store results
  results <- eventReactive(input$run, {
    data <- dataset()
    if (!is.null(data)) {
      X <- as.matrix(data[, input$predictors, drop = FALSE])
      y <- as.numeric(data[[input$response]])
      logistic_regression(X, y, input$bootstrap, input$alpha)
    }
  })
  
  # Render outputs
  output$coefficients <- renderTable({
    req(results())
    data.frame(Coefficients = results()$beta)
  })
  
  output$confidence_intervals <- renderTable({
    req(results())
    CI <- results()$CI
    t(CI)
  })
  
  output$confusion_matrix <- renderTable({
    req(results())
    results()$confusion_matrix
  })
  
  output$performance_metrics <- renderTable({
    req(results())
    results()$metrics
  })
  
  # Download results
  output$downloadResults <- downloadHandler(
    filename = function() { paste("logistic_regression_results_", Sys.Date(), ".csv", sep = "") },
    content = function(file) {
      req(results())
      write.csv(results()$metrics, file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)
```
